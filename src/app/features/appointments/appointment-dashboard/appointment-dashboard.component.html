<div *ngIf="!isLargeScreen || isFilterActive" #appointmentContainer class="p-2 sm:p-3 appointment-list-container md:overflow-auto relative">
  <h3 class="m-1 sm:m-0 text-center text-white-alpha-60" *ngIf="emptyAppointmentCollection(appointments)">
    {{ 'appointments.no_appointment' | translate }}
  </h3>
  <div *ngFor="let appointmentGroups of appointments | keyvalue">
    <div *ngIf="appointmentGroups.value.length" class="m-0 flex font-bold text-blue-5005 text-bluegray-600">
      <span>{{appointmentGroups.key | date : 'yyyy/MM/dd' }}</span>
      <span class="border-bottom-1 border-bluegray-600 block w-full mx-3 mb-2"></span>
    </div>
    <div
      *ngFor="let appointment of appointmentGroups.value; index as index"
      [class.scalein]="!isFilterActive"
      class="card shadow-2 mx-2 my-3 sm:m-3 p-3 sm:p-4 border-round-xl text-white-alpha-70">
      <div class="flex justify-content-between align-items-center">
        <div class="text-sm sm:text-base">
          <div class="flex">
            <i class="pi pi-user"></i>
            <h4 class="mx-1 my-0">{{ 'appointments.patient' | translate }}: </h4>
            <p (click)="navigateToPatient(appointment['phone'])"
               class="my-0 hover:text-white-alpha-90 cursor-pointer word-break max-w-7rem">{{appointment['firstName']}} {{appointment['lastName']}}</p>
          </div>
          <div class="flex pt-1">
            <i class="pi pi-calendar"></i>
            <h4 class="mx-1 my-0">{{ 'appointments.date' | translate }}: </h4>
            <p class="my-0 font-bold text-white-alpha-80 word-break">{{appointment['date'] | date : 'HH:mm'}}</p>
            <span>{{appointment['date'] | date : ', EEEE'}}</span>
          </div>
          <div class="flex pt-1">
            <i class="pi pi-home"></i>
            <h4 class="mx-1 my-0">{{ 'appointments.cabinet' | translate }}: </h4>
            <p class="my-0 word-break">{{appointment['cabinetNumber']}}</p>
          </div>
          <div class="flex pt-1">
            <i class="pi pi-heart"></i>
            <h4 class="mx-1 my-0">{{ 'appointments.treatment' | translate }}: </h4>
            <p class="my-0 word-break">{{appointment['description']}}</p>
          </div>
        </div>
        <div class="flex flex-column sm:flex-row justify-content-center align-items-center gap-2">
          <button
            type="button"
            pRipple
            (click)="processAppointmentToDelete(appointmentGroups.key, index)"
            class="p-button p-2 sm:px-3 md:py-3 md:px-4 bg-red-800 hover:bg-red-700">
            <i class="pi pi-trash text-sm md:text-xl text-white-alpha-80"></i>
          </button>
          <button
            type="button"
            pRipple
            (click)="displayUpdateAppointmentDialog(appointmentGroups.key, index, appointment)"
            class="p-button p-2 sm:px-3 md:py-3 md:px-4 bg-gray-700 hover:bg-gray-600">
            <i class="pi pi-cog text-sm md:text-xl text-white-alpha-80"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<button
  pRipple
  (click)="displayAppointmentDialog()"
  class="p-button bg-green-900 hover:bg-green-800 fixed mr-4 mb-5 bottom-0 z-1
    right-0 border-round-3xl flex justify-content-center w-3rem h-3rem shadow-8 text-bluegray-300 hover:text-bluegray-100">
  <i class="pi pi-calendar-plus text-2xl"></i>
</button>

<div *ngIf="!isFilterActive && isLargeScreen" class="schedule-container relative px-4 py-3">
  <div class="w-full relative border-round-md">
    <div class="flex">
      <div class="w-4rem pl-1">
        <!--      TODO please create a better design-->
        <p-calendar
          (ngModelChange)="changeCalendarMonth($event)"
          class="p-inputtext-sm month-picker"
          view="month" [dateFormat]="'M'"
          [yearNavigator]="false"
          [(ngModel)]="calendarMonth">
        </p-calendar>
      </div>
      <div class="w-full text-white-alpha-80 flex justify-content-around align-items-center pr-2">
        <h5 class="my-0" *ngFor="let day of calendarBoxes['00'] | keyvalue; first as first">
          <span [class.text-blue-500]="isToday(day.key)">{{ day.key | date : 'dd' }}</span>
        </h5>
      </div>
    </div>
    <div class="flex shadow-bottom border-bottom-3 border-white-alpha-10">
<!--      TODO please create a better design-->
      <div class="w-3rem px-5 opacity-8 text-white-alpha-20 flex align-items-center justify-content-center">
        <i
          (click)="changeCalendarWeek(-1)"
          [class]="disabledRevertWeeks ? 'opacity-30' : 'hover:text-white-alpha-30 hover:border-white-alpha-30 cursor-pointer'"
          class="pi pi-angle-left border-1 border-white-alpha-20 border-round-left-sm transition-duration-100"></i>
        <i
          (click)="changeCalendarWeek(1)"
          class="pi pi-angle-right border-1 border-white-alpha-20 border-round-right-sm hover:text-white-alpha-30
          hover:border-white-alpha-30 transition-duration-100 cursor-pointer"></i>
      </div>
      <div class="flex justify-content-evenly w-full pr-2">
        <div
          *ngFor="let day of days"
          class="w-full text-white-alpha-90 flex justify-content-center align-items-center my-2">
          {{ day | translate }}
        </div>
      </div>
    </div>

    <div class="box-container overflow-y-auto">
      <div *ngFor="let calendarBox of calendarBoxes | keyvalue; last as lastLine" class="flex hover:bg-white-alpha-5">
        <div class="w-3rem bg-white-alpha-5 px-5 flex justify-content-center align-items-center text-white-alpha-90">{{ calendarBox.key }}:00</div>
        <div class="flex justify-content-evenly w-full">
          <div
            *ngFor="let dateKeyvalue of (calendarBox.value | keyvalue); last as lastBox"
            [class.border-right-1]="!lastBox"
            [class.border-bottom-1]="!lastLine"
            (dblclick)="onCalendarBoxSelect(dateKeyvalue.key, calendarBox.key)"
            class="w-full p-1 box border-bluegray-800">
            <div
              *ngFor="let appointment of dateKeyvalue.value"
              (dblclick)="updateCalendarBoxAppointment(dateKeyvalue.key, appointment)"
              class="p-3 text-sm border-round-sm m-1 flex gap-1 relative">
              <div pRipple class="card absolute w-full top-0 right-0 p-2 border-round-sm p-unselectable-text extended">
                <div class="flex gap-1 text-sm title">
                  <span class="text-bluegray-400">{{appointment.date | date : 'HH:mm' }}</span>
                  <span class="text-bluegray-400">â€¢</span>
                  <span class="text-blue-400 overflow-hidden white-space-nowrap text-overflow-ellipsis">
                  {{appointment.firstName}} {{appointment.lastName}}
                </span>
                </div>

                <div class="text-sm details text-bluegray-300 px-2 h-full flex flex-column justify-content-center relative">
                  <div class="flex">
                    <i class="pi pi-user text-sm line-height-1"></i>
                    <p
                      (click)="navigateToPatient(appointment['phone'])"
                      class="my-0 mx-1 font-bold text-blue-400 hover:text-bluegray-100
                      cursor-pointer white-space-nowrap overflow-hidden text-overflow-ellipsis z-5">
                      {{appointment['firstName']}} {{appointment['lastName']}}
                    </p>
                  </div>
                  <div class="flex pt-1">
                    <i class="pi pi-calendar text-sm line-height-1"></i>
                    <span class="my-0 mx-1 text-bluegray-200 word-break">
                      {{appointment['date'] | date : 'HH:mm'}}
                    </span>
                  </div>
                  <div class="flex pt-1">
                    <i class="pi pi-home text-sm line-height-1"></i>
                    <p class="mx-1 my-0 font-bold">
                      {{ 'appointments.cabinet' | translate }} {{ appointment['cabinetNumber'].length ? appointment['cabinetNumber'] : '1' }}
                    </p>
                  </div>
                  <div *ngIf="appointment['doctor']?.length" class="flex pt-1">
                    <i class="pi pi-id-card text-sm line-height-1"></i>
                    <p class="mx-1 my-0 font-bold">{{ appointment['doctor'] }}</p>
                  </div>
                  <p class="my-0 word-break">{{appointment['cabinetNumber']}}</p>
                  <div class="flex pt-1">
                    <i class="pi pi-heart text-sm line-height-1"></i>
                    <p *ngIf="!appointment['description']?.length" class="my-0 mx-1 font-bold">{{ 'appointments.treatment' | translate }}: ?</p>
                    <p class="my-0 mx-1 white-space-nowrap overflow-hidden text-overflow-ellipsis">{{appointment['description']}}</p>
                  </div>
                  <i
                    (click)="updateCalendarBoxAppointment(dateKeyvalue.key, appointment)"
                    class="pi pi-eye z-5 text-sm absolute text-bluegray-400
                    hover:text-bluegray-200 transition-duration-100 cursor-pointer right-0 bottom-0">
                  </i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="shadow-top border-bottom-3 border-white-alpha-10"></div>
  </div>
</div>

<p-dialog [modal]="true"
          [dismissableMask]="true"
          [resizable]="false"
          [autoZIndex]="false"
          [closeOnEscape]="false"
          [closable]="true"
          (onHide)="onAppointmentDialogClose()"
          (onShow)="focusNextInput(firstNameInput)"
          [(visible)]="showAppointmentDialog">
  <form
    (keydown.delete)="openConfirmDialog()"
    (keydown.control.enter)="editedAppointmentIndex < 0 ? saveAppointment() : updateAppointment()"
    [formGroup]="appointmentFormGroup"
    class="w-75vw sm:w-22rem">
    <div class="grid grid-nogutter">
      <div class="col-6 pr-1">
        <p class="m-1 text-sm text-white-alpha-70">{{ 'form.first_name' | translate }}:</p>
        <input type="text" (keyup.enter)="focusNextInput(lastNameInput)" #firstNameInput pInputText formControlName="firstName"/>
      </div>
      <div class="col-6 pl-1">
        <p class="m-1 text-sm text-white-alpha-70">{{ 'form.last_name' | translate }}:</p>
        <input (keyup.enter)="focusNextInput(phoneInput)" #lastNameInput pInputText formControlName="lastName"/>
      </div>
    </div>
    <p class="m-1 text-sm text-white-alpha-70">{{ 'form.phone' | translate }}</p>
    <div class="flex phone-input">
      <p-dropdown
        [options]="countryCodes"
        [(ngModel)]="selectedCountryCode"
        [ngModelOptions]="standaloneConfiguration"
        [virtualScroll]="true"
        [virtualScrollItemSize]="10"
        [filter]="true"
        optionLabel="name">
        <ng-template pTemplate="selectedItem">
          <div class="flex align-items-center justify-content-center gap-1" *ngIf="selectedCountryCode">
            <img [src]="selectedCountryCode.image" [alt]="selectedCountryCode.name" width="25"/>
            <div>{{ selectedCountryCode.dial_code }}</div>
          </div>
        </ng-template>
        <ng-template let-country pTemplate="item">
          <div *ngIf="country.dial_code?.length" class="flex align-items-center gap-2">
            ({{country.dial_code}}) {{ country.name }}
          </div>
        </ng-template>
      </p-dropdown>
      <input
        autocomplete="off"
        #phoneInput
        id="phone"
        pKeyFilter="int"
        class="p-inputtext"
        pInputText
        formControlName="phone"
        [maxLength]="15"
        [minlength]="7"
        [minLength]="7"
        [placeholder]="'712345678'"
        (keyup.enter)="focusNextInput(dateInput)"/>
    </div>
    <div class="flex gap-2">
      <div class="w-full">
        <p class="m-1 pt-1 text-sm text-white-alpha-70">{{ 'form.date' | translate }}:</p>
        <p-calendar
          #dateInput
          [minDate]="today"
          [dateFormat]="'yy/mm/dd'"
          (keyup.enter)="focusNextInput(timeInput)"
          formControlName="date">
        </p-calendar>
      </div>
      <div class="flex align-items-end">
        <p-calendar
          #timeInput
          [(ngModel)]="time"
          [ngModelOptions]="standaloneConfiguration"
          (keyup.enter)="focusNextInput(descriptionInput)"
          [timeOnly]="true">
        </p-calendar>
      </div>
    </div>

    <p class="m-1 text-sm text-white-alpha-70">{{ 'form.description' | translate }}:</p>
    <textarea #descriptionInput pInputTextarea formControlName="description"></textarea>
    <div [class]="editedAppointmentIndex < 0 ? 'justify-content-end' : 'justify-content-between'" class="flex  mt-3">
      <button
        type="button"
        pRipple
        *ngIf="editedAppointmentIndex > -1"
        (click)="openConfirmDialog()"
        class="p-button bg-transparent border-1 border-solid border-gray-700 hover:bg-gray-700 text-white-alpha-70 hover:text-white-alpha-90">
        <i class="pi pi-trash text-sm md:text-xl text-white-alpha-80"></i>
      </button>
      <div class="flex gap-2">
        <button pRipple type="button" (click)="closeAppointmentDialog()" class="p-button cancel">{{ 'button.cancel' | translate }}</button>
        <button pRipple
                type="button"
                [disabled]="!appointmentFormGroup.valid || !time"
                (click)="editedAppointmentIndex < 0 ? saveAppointment() : updateAppointment()"
                class="p-button">{{ 'button.save' | translate }}
        </button>
      </div>

    </div>
  </form>
</p-dialog>

<p-dialog [modal]="true"
          [resizable]="false"
          [autoZIndex]="false"
          [closable]="false"
          [closeOnEscape]="false"
          [(visible)]="showAppointmentConflictDialog">
  <ng-template pTemplate="header">
    <div class="w-full flex justify-content-between align-items-center">
      <span class="mx-2">{{ 'appointments.conflict_dialog.title' | translate }}</span>
      <div class="p-button-icon">
        <button (click)="resolveAppointmentConflict('')" type="button" class="p-dialog-header-icon cursor-pointer">
          <i pRipple class="pi pi-times"></i>
        </button>
      </div>
    </div>
  </ng-template>
  <div class="sm:w-17re max-w-30rem flex flex-column mt-1">
    <span>
      {{ 'appointments.conflict_dialog.already_registered' | translate }}
    </span>
    <span class="m-1 text-green-800 font-bold text-lg">
      {{ selectedCountryCode.dial_code + appointmentFormGroup.value['phone']}}
    </span>
    <span>
      {{ 'appointments.conflict_dialog.no_match' | translate }}
    </span>
    <span class="text-xs text-white-alpha-80 mt-3">
      {{ 'appointments.conflict_dialog.appointment_name' | translate }}
    </span>
    <span class="m-1 p-2 text-red-700 font-bold text-lg border-1 border-round border-bluegray-700 w-fit">
      {{ appointmentFormGroup.value['firstName'] }} {{ appointmentFormGroup.value['lastName'] }}
    </span>
    <span class="text-xs text-white-alpha-80">{{ 'appointments.conflict_dialog.original_name' | translate }}</span>
    <span class="m-1 p-2 text-blue-700 font-bold text-lg border-1 border-round border-bluegray-700 w-fit">
      {{ appointmentConflictDetails?.patientFirstName }} {{ appointmentConflictDetails?.patientLastName }}
    </span>
    <div class="flex justify-content-between align-items-center mt-2">
      <i class="pi pi-question-circle mx-1 mt-4 text-bluegray-700 hover:text-bluegray-600 transition-duration-200 outline-none"
         #tooltip
         [tooltipEvent]="'focus'"
         [tabindex]="0"
         (mouseover)="showTooltip($event, tooltip)"
         (mouseleave)="hideTooltip($event, tooltip)"
         (click)="showTooltip($event, tooltip)"
         [pTooltip]="'appointments.conflict_dialog.tooltip' | translate">
      </i>
      <div>
        <span class="text-xs text-white-alpha-80">{{ 'appointments.conflict_dialog.modify' | translate }}</span>
        <div class="flex gap-1 mt-1">
          <button class="p-button p-button-sm" (click)="resolveAppointmentConflict('overrideAppointment')">
            {{ 'appointments.appointment' | translate }}
          </button>
          <button class="p-button p-button-sm bg-blue-700 hover:bg-blue-600" (click)="resolveAppointmentConflict('overridePatient')">
            {{ 'appointments.patient' | translate }}
          </button>
        </div>
      </div>
    </div>
  </div>
</p-dialog>

<p-dialog [modal]="true"
          [dismissableMask]="true"
          [resizable]="false"
          [closeOnEscape]="true"
          [closable]="true"
          [showHeader]="false"
          class="no-header min-w-75vw"
          [(visible)]="showConfirmDialog">
  <h3 class="text-center m-4">{{ 'appointments.are_you_sure' | translate }}</h3>
  <div class="flex justify-content-center">
    <button (click)="closeConfirmDialog()"
            class="p-button bg-red-800 hover:bg-red-700 border-red-700 mx-2">
      <i class="pi pi-times text-white-alpha-90"></i>
    </button>
    <button (click)="deleteAppointment()"
            class="p-button bg-green-800 hover:bg-green-700 border-green-700 mx-2">
      <i class="pi pi-check text-white-alpha-90"></i>
    </button>
  </div>
</p-dialog>

<p-toast></p-toast>
