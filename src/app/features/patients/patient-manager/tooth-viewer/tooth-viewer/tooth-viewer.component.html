<div class="relative overflow-hidden w-full flex justify-content-center" #parentContainer>
  <div>
    <h1 class="text-white-alpha-80 text-center">{{ notation.label }}</h1>
    <!-- TODO Add tooth name (like molar, premolar, incisor, etc)-->
    <img (dblclick)="addPreviousCare($event)"
         (touchstart)="onTouchStart($event)"
         [class.opacity-60]="tooth.status === 'missing'"
         class="w-18rem sm:w-20rem md:w-25rem lg:w-30rem"
         [src]="'assets/images/tooth/' + ( tooth.status === 'implant' ? 'implant_' : '' ) + notation.image">
    <div *ngIf="tooth">
      <div #previousCareLabel *ngFor="let previousCare of tooth.previousCares; index as previousCareIndex"
           cdkDrag
           (cdkDragEnded)="dragEndedPreviousCare($event, previousCareIndex)"
           [cdkDragBoundary]="parentContainer"
           class="absolute flex line">
        <div class="hidden sm:block w-5rem md:w-8rem lg:w-14rem border-bottom-1 mt-1"></div>
        <div
          (click)="displayPreviousCareDialog(previousCareIndex)"
          class="label max-w-17rem border-bottom-1 p-1 sm:p-2
            border-round-top text-xs lg:text-base transition-duration-200 cursor-pointer">
          <div *ngIf="previousCare.service.label?.length">
            <span *ngIf="previousCare.service.custom">{{ previousCare.service.label }}</span>
            <span *ngIf="!previousCare.service.custom">{{ ('services_list.' + previousCare.service.label) | translate }}</span>
            <span *ngIf="previousCare.date"
                  class="text-white-alpha-70">: {{ previousCare.date | date : 'YYYY-MM-dd' }}</span>
          </div>
        </div>
      </div>
    </div>
    <div class="flex my-4 gap-1 justify-content-center relative">
      <p-menu #statusMenu [model]="toothStatusOptions" [popup]="true"/>
      <button pRipple (click)="toggleStatusMenu(statusMenu, $event)" class="p-button px-1 font-medium"><i class="pi pi-ellipsis-v"></i></button>
      <button pRipple (click)="closeToothDialog()" class="p-button font-medium">{{ 'button.close' | translate }}</button>
    </div>
  </div>
</div>

<p-dialog [modal]="true"
          [dismissableMask]="true"
          [resizable]="false"
          [autoZIndex]="true"
          [closeOnEscape]="true"
          class="previous-care-dialog"
          (onHide)="onPreviousCareDialogClose()"
          (onShow)="forceToothDialog.emit(true)"
          (keydown.control.enter)="closePreviousCareDialog()"
          [(visible)]="showPreviousCareDialog">
  <div class="w-75vw sm:w-20rem">
    <p class="m-1 text-sm text-white-alpha-70 ">{{ 'form.treatment' | translate }}:</p>
    <p-dropdown
      styleClass="dialog-dropdown"
      [filter]="true"
      [filterBy]="'searchLabel'"
      (ngModelChange)="changeSelectedAvailableService($event)"
      [options]="availableServices"
      [(ngModel)]="selectedAvailableService">
      <ng-template pTemplate="selectedItem">
        <span *ngIf="selectedAvailableService.custom">{{ selectedAvailableService.label }}</span>
        <span *ngIf="!selectedAvailableService.custom">{{ ('services_list.' + selectedAvailableService.label) | translate }}</span>
      </ng-template>
      <ng-template let-service pTemplate="item">
        <span *ngIf="service.custom">{{ service.label }}</span>
        <span *ngIf="!service.custom">{{ ('services_list.' + service.label) | translate }}</span>
      </ng-template>
    </p-dropdown>
    <div *ngIf="showMissingServiceWarning"
         class="flex align-items-center my-1 text-orange-600 hover:text-orange-500 transition-duration-100 cursor-default">
      <i [pTooltip]="'patient_manager.missing_available_service_tooltip' | translate"
         #tooltip
         [tooltipEvent]="'focus'"
         [tabindex]="0"
         (mouseover)="showTooltip($event, tooltip)"
         (mouseleave)="hideTooltip($event, tooltip)"
         (click)="showTooltip($event, tooltip)"
         class="pi pi-exclamation-triangle px-1 text-sm outline-none"></i>
      <span class="text-xs">{{ 'patient_manager.missing_available_service' | translate }}</span>
    </div>
    <p class="m-1 pt-1 text-sm text-white-alpha-70">{{ 'form.date' | translate }}:</p>
    <p-calendar
      #dateInput
      (keyup.enter)="focusNextInput(descriptionInput)"
      [dateFormat]="'yy/mm/dd'"
      [(ngModel)]="previousCareToShow.date">
    </p-calendar>
    <p class="m-1 pt-1 text-sm text-white-alpha-70">{{ 'form.description' | translate }}</p>
    <textarea #descriptionInput pInputTextarea class="h-6rem" [(ngModel)]="previousCareToShow.description"></textarea>
    <div [class]="isNewPreviousCare ? 'justify-content-end' : 'justify-content-between'" class="flex mt-3">
      <button
        *ngIf="!isNewPreviousCare"
        pRipple
        type="button"
        (click)="deletePreviousCare()"
        class="p-button bg-transparent border-1 border-solid border-gray-700 hover:bg-gray-700 text-white-alpha-70 hover:text-white-alpha-90">
        <i class="pi pi-trash text-xl"></i>
      </button>
      <button pRipple type="button" (click)="closePreviousCareDialog()" class="p-button">{{ 'button.done' | translate }}</button>
    </div>
  </div>
</p-dialog>

<p-toast></p-toast>
